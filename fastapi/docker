# ---- Base image
FROM python:3.11-slim AS base

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PIP_NO_CACHE_DIR=1

# ---- System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ---- Workdir
WORKDIR /app

# ---- Install Python deps
# 既然你的文件名叫 requirement.txt (单数)，这里必须保持一致
COPY requirement.txt ./requirement.txt
RUN pip install -r requirement.txt

# ---- Copy application code
# 只拷贝 app 文件夹，其他的不要乱拷
COPY app ./app

# ---- Non-root user (安全设置)
RUN useradd -m appuser
USER appuser

# ---- Env & Ports
ENV PORT=8000
EXPOSE 8000

# ---- Start Command
CMD gunicorn app.main:app \
    -k uvicorn.workers.UvicornWorker \
    -w 2 \
    -b 0.0.0.0:${PORT} \
    --log-level info